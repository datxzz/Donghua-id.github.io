<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Portal</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        /* Admin Mode Styles */
        .admin-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .login-form {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: center;
            margin-top: 50px;
        }
        
        .upload-section {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        /* Viewer Mode Styles */
        .viewer-container {
            width: 100%;
            height: 100vh;
            background: black;
            position: relative;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        .video-wrapper {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        }
        
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Common Styles */
        input[type="password"], input[type="file"], input[type="text"] {
            margin: 10px 0;
            padding: 12px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            -webkit-appearance: none;
            font-size: 16px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
            font-size: 16px;
            -webkit-appearance: none;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .hidden {
            display: none !important;
        }
        
        .error {
            color: red;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .share-link-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 4px;
        }
        
        .share-link-container input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .video-list {
            margin-top: 20px;
        }
        
        .video-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-container {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Error states */
        .error-state {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(0,0,0,0.8);
            color: white;
            z-index: 20;
            text-align: center;
            padding: 20px;
        }
        
        .retry-btn {
            margin-top: 15px;
            background-color: #f44336;
        }
        
        .retry-btn:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <div id="admin-container" class="admin-container hidden">
        <div id="login-form" class="login-form">
            <h2>Admin Login</h2>
            <input type="password" id="admin-password" placeholder="Enter password">
            <button id="login-btn">Login</button>
            <p id="login-error" class="error hidden">Incorrect password</p>
        </div>
        
        <div id="upload-section" class="upload-section hidden">
            <h2>Upload Video</h2>
            <input type="file" id="video-upload" accept="video/*">
            <div class="progress-container hidden" id="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <button id="upload-btn">Upload Video</button>
            <p id="upload-error" class="error hidden"></p>
            
            <div id="share-link-container" class="share-link-container hidden">
                <h3>Shareable Link</h3>
                <input type="text" id="share-link" readonly>
                <button id="copy-btn">Copy Link</button>
                <p id="copy-status" class="hidden">Link copied!</p>
            </div>
            
            <div class="video-list">
                <h3>Uploaded Videos</h3>
                <div id="videos-list"></div>
            </div>
        </div>
    </div>
    
    <div id="viewer-container" class="viewer-container">
        <div class="video-wrapper">
            <video id="video-player" playsinline webkit-playsinline>
                Your browser does not support the video tag.
            </video>
            <button id="play-button" class="play-button">▶</button>
            <div id="error-display" class="error-state hidden">
                <h3>Error Playing Video</h3>
                <p id="error-message"></p>
                <button id="retry-btn" class="retry-btn">Retry</button>
            </div>
        </div>
        <button id="fullscreen-btn" class="fullscreen-btn">⛶</button>
    </div>

    <script>
        // Configuration
        const ADMIN_PASSWORD = "DatxzzPhoenix123";
        const DB_NAME = "VideoPortalDB";
        const STORE_NAME = "videos";
        const DB_VERSION = 2; // Increment this version if you change your database schema
        const MAX_VIDEO_SIZE = 800 * 1024 * 1024; // 800MB
        let db;
        let currentVideo = null;
        let currentVideoUrl = null; // To keep track of the object URL for revoking
        
        // DOM Elements
        const adminContainer = document.getElementById('admin-container');
        const viewerContainer = document.getElementById('viewer-container');
        const videoPlayer = document.getElementById('video-player');
        const playButton = document.getElementById('play-button');
        const videosList = document.getElementById('videos-list');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const errorDisplay = document.getElementById('error-display');
        const errorMessage = document.getElementById('error-message');
        const retryBtn = document.getElementById('retry-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        
        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION); // Use DB_VERSION here
                
                request.onerror = (event) => {
                    console.error("Database error:", event.target.error);
                    reject(event.target.error);
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log(`Database opened successfully with version ${db.version}`);
                    
                    // You might want to do a full integrity check only if necessary
                    // For now, assume onsuccess means the database is ready
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    console.log(`Database upgrade needed from version ${event.oldVersion} to ${event.newVersion}`);
                    
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        console.log(`Object store '${STORE_NAME}' created.`);
                    }
                    // If you later add new features that require a new object store or
                    // a different index, you would increment DB_VERSION and add
                    // conditional logic here based on event.oldVersion.
                    // Example:
                    // if (event.oldVersion < 2) {
                    //    // Add new indexes or stores for version 2
                    // }
                };
            });
        }
        
        // Save video to IndexedDB
        function saveVideo(videoData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                transaction.onerror = (event) => reject(event.target.error);
                transaction.oncomplete = () => resolve(videoData.id);
                
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(videoData);
                
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        // Get video from IndexedDB
        function getVideo(videoId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                
                const request = store.get(videoId);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }
        
        // Get all videos from IndexedDB
        function getAllVideos() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                
                const request = store.getAll();
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }
        
        // Render video list
        async function renderVideoList() {
            try {
                const videos = await getAllVideos();
                videosList.innerHTML = '';
                
                if (videos.length === 0) {
                    videosList.innerHTML = '<p>No videos uploaded yet.</p>';
                    return;
                }
                
                videos.forEach(video => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'video-item';
                    
                    videoItem.innerHTML = `
                        <span>${video.name || video.id}</span>
                        <div>
                            <button class="play-video-btn" data-id="${video.id}">Play</button>
                            <button class="share-video-btn" data-id="${video.id}">Share</button>
                            <button class="delete-video-btn" data-id="${video.id}">Delete</button>
                        </div>
                    `;
                    
                    videosList.appendChild(videoItem);
                });
                
                // Add event listeners to the buttons
                document.querySelectorAll('.play-video-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const videoId = e.target.getAttribute('data-id');
                        // Switch to viewer mode and play the video
                        window.history.pushState({}, '', `?v=${videoId}`); // Update URL
                        playVideoFromDB(videoId);
                        showViewerMode();
                        adminContainer.classList.add('hidden');
                    });
                });
                
                document.querySelectorAll('.share-video-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const videoId = e.target.getAttribute('data-id');
                        generateShareLink(videoId);
                    });
                });
                
                document.querySelectorAll('.delete-video-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        if (confirm('Are you sure you want to delete this video?')) {
                            const videoId = e.target.getAttribute('data-id');
                            try {
                                await deleteVideo(videoId);
                                if (currentVideo && currentVideo.id === videoId) {
                                    // If the currently playing video is deleted, clear the player
                                    videoPlayer.pause();
                                    videoPlayer.src = '';
                                    if (currentVideoUrl) {
                                        URL.revokeObjectURL(currentVideoUrl);
                                        currentVideoUrl = null;
                                    }
                                    currentVideo = null;
                                    playButton.classList.remove('hidden'); // Show play button again
                                    errorDisplay.classList.add('hidden'); // Hide any error
                                }
                            } catch (error) {
                                console.error("Error deleting video:", error);
                                showUploadError("Could not delete video.");
                            }
                        }
                    });
                });
                
            } catch (error) {
                console.error("Error rendering video list:", error);
                videosList.innerHTML = '<p class="error">Error loading videos</p>';
            }
        }
        
        // Delete video from IndexedDB
        function deleteVideo(videoId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                transaction.onerror = (event) => reject(event.target.error);
                transaction.oncomplete = () => {
                    renderVideoList();
                    resolve();
                };
                
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(videoId);
                
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        // Play video from IndexedDB with enhanced error handling
        async function playVideoFromDB(videoId) {
            if (!db) {
                showVideoError('Database not initialized. Please refresh.');
                return;
            }
            
            // Revoke previous object URL if any
            if (currentVideoUrl) {
                URL.revokeObjectURL(currentVideoUrl);
                currentVideoUrl = null;
            }
            videoPlayer.pause(); // Pause any currently playing video
            videoPlayer.src = ''; // Clear source immediately
            
            errorDisplay.classList.add('hidden');
            playButton.classList.add('hidden');
            
            try {
                const video = await getVideo(videoId);
                if (!video) {
                    throw new Error('Video not found in database.');
                }
                
                // Create object URL from blob
                currentVideoUrl = URL.createObjectURL(video.blob);
                
                // Set up error handling before setting src
                videoPlayer.onerror = () => {
                    showVideoError('Failed to load video. The format may not be supported or the file is corrupted.');
                    if (currentVideoUrl) {
                        URL.revokeObjectURL(currentVideoUrl);
                        currentVideoUrl = null;
                    }
                };
                
                // Set up loaded event (optional, for debugging)
                videoPlayer.onloadeddata = () => {
                    console.log('Video loaded successfully');
                    playButton.classList.add('hidden'); // Hide play button after data is loaded and ready to play
                };
                
                videoPlayer.src = currentVideoUrl;
                currentVideo = video;
                
                // Try to play with different approaches for different browsers
                const attemptPlay = async () => {
                    try {
                        await videoPlayer.play();
                        playButton.classList.add('hidden'); // Hide button if successful
                    } catch (err) {
                        console.log('Autoplay blocked, showing play button:', err);
                        playButton.classList.remove('hidden');
                        showVideoError('Autoplay prevented. Tap the play button to start.');
                        // Do not re-throw, as user can click the play button
                    }
                };
                
                await attemptPlay();
                
            } catch (error) {
                console.error("Error playing video:", error);
                showVideoError(error.message || 'Error playing video.');
                
                if (currentVideoUrl) {
                    URL.revokeObjectURL(currentVideoUrl);
                    currentVideoUrl = null;
                }
                playButton.classList.remove('hidden'); // Ensure play button is visible on error
            }
        }
        
        // Show video error with retry option
        function showVideoError(message) {
            errorMessage.textContent = message;
            errorDisplay.classList.remove('hidden');
            playButton.classList.add('hidden');
        }
        
        // Generate share link
        function generateShareLink(videoId) {
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?v=${videoId}`;
            document.getElementById('share-link').value = shareUrl;
            document.getElementById('share-link-container').classList.remove('hidden');
        }
        
        // Check URL for video parameter or admin mode
        const urlParams = new URLSearchParams(window.location.search);
        const videoIdFromUrl = urlParams.get('v');
        const isAdminMode = urlParams.get('admin') === 'true';
        
        // Initialize the app
        async function initApp() {
            try {
                await initDB();
                
                if (videoIdFromUrl) {
                    // Public viewer mode with a specific video
                    await playVideoFromDB(videoIdFromUrl);
                    showViewerMode();
                    adminContainer.classList.add('hidden');
                } else if (isAdminMode) {
                    // Admin mode
                    showAdminMode();
                    viewerContainer.classList.add('hidden');
                } else {
                    // Default to viewer mode (no specific video selected, show play button)
                    showViewerMode();
                    adminContainer.classList.add('hidden');
                    // No video loaded initially, so play button should be visible
                    playButton.classList.remove('hidden'); 
                    errorMessage.textContent = 'No video selected. Ask an admin for a link.';
                    errorDisplay.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Initialization error:", error);
                showVideoError("Error initializing application. Please refresh the page. " + error.message);
            }
        }
        
        function showAdminMode() {
            adminContainer.classList.remove('hidden');
            
            // Login functionality
            document.getElementById('login-btn').addEventListener('click', function() {
                const password = document.getElementById('admin-password').value;
                if (password === ADMIN_PASSWORD) {
                    document.getElementById('login-error').classList.add('hidden');
                    document.getElementById('login-form').classList.add('hidden');
                    document.getElementById('upload-section').classList.remove('hidden');
                    renderVideoList();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                }
            });
            
            // Upload functionality
            document.getElementById('upload-btn').addEventListener('click', async function() {
                const fileInput = document.getElementById('video-upload');
                if (!fileInput.files.length) {
                    showUploadError('Please select a video file.');
                    return;
                }
                
                const file = fileInput.files[0];
                if (!file.type.startsWith('video/')) {
                    showUploadError('Please select a valid video file.');
                    return;
                }
                
                if (file.size > MAX_VIDEO_SIZE) {
                    showUploadError(`Video too large (max ${MAX_VIDEO_SIZE/1024/1024}MB).`);
                    return;
                }
                
                // Show progress bar
                progressContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                document.getElementById('upload-btn').disabled = true; // Disable upload button during upload
                
                // Read file as ArrayBuffer with progress tracking
                const reader = new FileReader();
                
                reader.onload = async function(event) {
                    try {
                        const arrayBuffer = event.target.result;
                        const blob = new Blob([arrayBuffer], { type: file.type });
                        
                        // Create video ID
                        const newVideoId = 'vid_' + Date.now() + Math.random().toString(36).substr(2, 8);
                        
                        // Save to IndexedDB
                        await saveVideo({
                            id: newVideoId,
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            blob: blob,
                            timestamp: new Date().toISOString()
                        });
                        
                        // Update progress to 100%
                        progressBar.style.width = '100%';
                        
                        // Generate shareable link
                        generateShareLink(newVideoId);
                        
                        // Refresh video list
                        await renderVideoList();
                        
                        // Clear file input and hide progress
                        fileInput.value = '';
                        document.getElementById('upload-btn').disabled = false; // Re-enable upload button
                        setTimeout(() => {
                            progressContainer.classList.add('hidden');
                            progressBar.style.width = '0%'; // Reset progress bar
                        }, 1000); // Give a slight delay to show 100%
                        
                    } catch (error) {
                        console.error("Error uploading video:", error);
                        showUploadError(`Error saving video: ${error.message || 'Unknown error'}`);
                        progressContainer.classList.add('hidden');
                        document.getElementById('upload-btn').disabled = false;
                    }
                };
                
                reader.onerror = function() {
                    showUploadError('Error reading file. Please try again.');
                    progressContainer.classList.add('hidden');
                    document.getElementById('upload-btn').disabled = false;
                };
                
                reader.onprogress = function(event) {
                    if (event.lengthComputable) {
                        const uploadProgress = Math.round((event.loaded / event.total) * 100);
                        progressBar.style.width = `${uploadProgress}%`;
                    }
                };
                
                reader.readAsArrayBuffer(file);
            });
            
            // Copy link functionality
            document.getElementById('copy-btn').addEventListener('click', function() {
                const shareInput = document.getElementById('share-link');
                shareInput.select();
                shareInput.setSelectionRange(0, 99999); // For mobile devices
                
                try {
                    document.execCommand('copy');
                    const copyStatus = document.getElementById('copy-status');
                    copyStatus.classList.remove('hidden');
                    setTimeout(() => copyStatus.classList.add('hidden'), 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy link. Please copy it manually.');
                }
            });
        }
        
        function showViewerMode() {
            viewerContainer.classList.remove('hidden');
            
            // Play button functionality
            playButton.addEventListener('click', function() {
                if (videoPlayer.paused) {
                    videoPlayer.play().then(() => {
                        playButton.classList.add('hidden');
                        errorDisplay.classList.add('hidden');
                    }).catch(err => {
                        console.error("Manual play error:", err);
                        showVideoError("Could not play video. " + err.message);
                    });
                } else {
                    videoPlayer.pause();
                    playButton.classList.remove('hidden');
                }
            });
            
            // Retry button functionality
            retryBtn.addEventListener('click', function() {
                playVideoFromDB(currentVideo?.id || videoIdFromUrl); // Try to play the current or URL video
            });
            
            // Show play button when video pauses
            videoPlayer.addEventListener('pause', function() {
                if (!videoPlayer.ended && !videoPlayer.seeking) {
                    playButton.classList.remove('hidden');
                }
            });

            // Hide play button when video starts playing
            videoPlayer.addEventListener('play', function() {
                playButton.classList.add('hidden');
                errorDisplay.classList.add('hidden'); // Clear error once playing
            });

            // Handle video ended
            videoPlayer.addEventListener('ended', function() {
                playButton.classList.remove('hidden');
            });

            // Fullscreen functionality
            fullscreenBtn.addEventListener('click', function() {
                if (videoPlayer.requestFullscreen) {
                    videoPlayer.requestFullscreen().catch(err => {
                        console.log("Fullscreen error:", err);
                    });
                } else if (videoPlayer.webkitEnterFullscreen) { // Safari
                    videoPlayer.webkitEnterFullscreen();
                } else {
                    alert('Fullscreen is not supported by this browser.');
                }
            });
            
            // Hide fullscreen button when in fullscreen
            document.addEventListener('fullscreenchange', function() {
                if (document.fullscreenElement) {
                    fullscreenBtn.classList.add('hidden');
                } else {
                    fullscreenBtn.classList.remove('hidden');
                }
            });

            document.addEventListener('webkitfullscreenchange', function() { // Safari
                if (document.webkitFullscreenElement) {
                    fullscreenBtn.classList.add('hidden');
                } else {
                    fullscreenBtn.classList.remove('hidden');
                }
            });
            
            // Handle video errors
            videoPlayer.addEventListener('error', function() {
                let message = 'Error playing video.';
                if (videoPlayer.error) {
                    switch(videoPlayer.error.code) {
                        case videoPlayer.error.MEDIA_ERR_ABORTED:
                            message = 'Video playback was aborted.';
                            break;
                        case videoPlayer.error.MEDIA_ERR_NETWORK:
                            message = 'A network error occurred while fetching the video.';
                            break;
                        case videoPlayer.error.MEDIA_ERR_DECODE:
                            message = 'The video could not be decoded. The file might be corrupt or the format unsupported.';
                            break;
                        case videoPlayer.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            message = 'The video format is not supported by your browser.';
                            break;
                        default:
                            message = 'An unknown video playback error occurred.';
                    }
                }
                showVideoError(message);
                if (currentVideoUrl) {
                    URL.revokeObjectURL(currentVideoUrl);
                    currentVideoUrl = null;
                }
                playButton.classList.remove('hidden'); // Show play button on error
            });
        }
        
        function showUploadError(message) {
            const errorElement = document.getElementById('upload-error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => errorElement.classList.add('hidden'), 5000); // Increased visibility time
        }
        
        // iOS specific handling for better compatibility
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            // Apply playsinline attributes via JS for robustness
            videoPlayer.setAttribute('playsinline', '');
            videoPlayer.setAttribute('webkit-playsinline', '');
            
            // Ensure fullscreen button is visible even with webkit-playsinline
            fullscreenBtn.style.display = 'flex'; 

            // Prevent iOS from going fullscreen automatically on play for inline videos
            videoPlayer.addEventListener('play', () => {
                if (videoPlayer.webkitSupportsFullscreen && !videoPlayer.webkitDisplayingFullscreen) {
                    // Do nothing, let it play inline
                }
            });

            // Larger tap targets for buttons (already in CSS, but reinforcing)
            document.querySelectorAll('button').forEach(btn => {
                btn.style.minHeight = '44px';
                btn.style.minWidth = '44px';
            });
        }
        
        // Start the application
        initApp();
    </script>
</body>
</html>

